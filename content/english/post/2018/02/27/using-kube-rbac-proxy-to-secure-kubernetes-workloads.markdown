+++
author = "Frederic Branczyk"
title = "Using kube-rbac-proxy to secure Kubernetes workloads"
date = "2018-02-27"
+++

While working on and around monitoring [Kubernetes](https://kubernetes.io/) clusters with [Prometheus](https://prometheus.io/), I have noticed a reoccurring problem: metrics that are retrieved by Prometheus may potentially contain sensitive information (for example the [Prometheus node-exporter](https://github.com/prometheus/node_exporter) exposes the Kernel version of the host), which a potential intruder may use in order to exploit their way through a respective Kubernetes cluster. So I asked myself the question: How does one authenticate and authorize requests from Prometheus so that Prometheus and only Prometheus can retrieve metrics from an application running in a Pod?

The default answer for authenticating and authorizing metric endpoints in Prometheus is using TLS client certificates, however, as issuing, verifying and rotating client certificates can get rather complicated, as a result, Prometheus requests are most of the time simply not authenticated and unauthorized.

I built the [kube-rbac-proxy](https://github.com/brancz/kube-rbac-proxy), a small HTTP proxy for a single upstream, that can perform RBAC authorization against the Kubernetes API using SubjectAccessReviews. In this post I want to explain, how it uses [Kubernetes RBAC](https://kubernetes.io/docs/admin/authorization/rbac/) to accomplish this.

## How does RBAC work behind the scenes?

Kubernetes role based access control (RBAC) itself solves only half of the problem. As the name suggests, it is only about access control, meaning authorization, not authentication. Before a request can be authorized, it needs to be authenticated. Simply said: we need to find out _who_ is performing this request. The mechanism for services to authenticate themselves in Kubernetes are [ServiceAccount](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) tokens.

The Kubernetes API exposes the ability to verify ServiceAccount tokens, using what is called a [TokenReview](https://kubernetes.io/docs/admin/authentication/#webhook-token-authentication). The response of a TokenReview is simply whether the ServiceAccount token was successfully verified, as well with as which user the specified token is associated. The kube-rbac-proxy, expects the ServiceAccount token to be specified in the `Authorization` HTTP header, and then verifies it using a TokenReview.

At this point, a request has been authenticated, but not yet authorized. Parallel to the TokenReview, Kuberenetes has a SubjectAccessReview, which is part of the authorization API. In a SubjectAccessReview an intended action is specified as well as the user who wants to perform it. In the concrete case of metrics being requested by Prometheus, the `/metrics` HTTP endpoint is requested. Unfortunately that is not a fully specified resource in Kubernetes, however, the SubjectAccessReview resource is also able to authorize so called "non-resource-urls". The possibilities are endless though, for example: authorizing a proxied request a SubjecAccessReview could also check to ensure a user has the `services/proxy` RBAC role.

When monitoring Kubernetes with Prometheus, then the Prometheus server likely already has permission to access the `/metrics` non-resource-url, as retrieving metrics from the Kubernetes apiserver requires the [same RBAC role](https://github.com/prometheus/prometheus/blob/090e7e09598d1ce5ec9d73e44cce7bf2db8dc7e2/documentation/examples/rbac-setup.yml#L19).

## kube-rbac-proxy in action

Now that all necessary pieces have been explained, let's see how the kube-rbac-proxy concretely authenticates and authorizes a request, with the case stated at the beginning of this blog post: Prometheus requesting metrics from the node-exporter.

When Prometheus performs a request against the node-exporter, with the kube-rbac-proxy in front of it, the kube-rbac-proxy performs a TokenReview with the provided ServiceAccount token, and if the TokenReview is successful, it continues to use the SubjectAccessReview to verify, that the ServiceAccount is authorized to access the `/metrics` HTTP endpoint.

Visualized, the full flow of authenticating and authorizing requests from Prometheus then looks like this:

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="669px" height="461px" version="1.1" style="max-width:100%;display:block;margin:auto;"><defs/><g transform="translate(0.5,0.5)"><rect x="140" y="0" width="100" height="40" rx="6" ry="6" fill="#ffffff" stroke="#000000" pointer-events="none"/><path d="M 190 40 L 190 460" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(142.5,14.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="94" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 95px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica">kube-rbac-proxy</font></b></div></div></foreignObject><text x="47" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><rect x="185" y="100" width="10" height="320" fill="#ffffff" stroke="#000000" pointer-events="none"/><rect x="300" y="0" width="100" height="40" rx="6" ry="6" fill="#ffffff" stroke="#000000" pointer-events="none"/><path d="M 350 40 L 350 460" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(309.5,14.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="81" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 82px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica">node-exporter</font></b></div></div></foreignObject><text x="41" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><rect x="440" y="0" width="100" height="40" rx="6" ry="6" fill="#ffffff" stroke="#000000" pointer-events="none"/><path d="M 490 40 L 490 460" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(445.5,14.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="89" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 90px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica">Kubernetes API</font></b></div></div></foreignObject><text x="45" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><rect x="0" y="0" width="100" height="40" rx="6" ry="6" fill="#ffffff" stroke="#000000" pointer-events="none"/><path d="M 50 40 L 50 460" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(15.5,14.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="69" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 70px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica">Prometheus</font></b><br /></div></div></foreignObject><text x="35" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><rect x="45" y="100" width="10" height="320" fill="#ffffff" stroke="#000000" pointer-events="none"/><rect x="485" y="100" width="10" height="250" fill="#ffffff" stroke="#000000" pointer-events="none"/><path d="M 55 100 L 110 100 Q 120 100 130 100 L 176.88 100" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 183.88 100 L 176.88 103.5 L 176.88 96.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(75.5,83.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="89" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">Request /metrics</font></b></div></div></foreignObject><text x="45" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><path d="M 195 125 L 328.5 125 Q 338.5 125 348.5 125 L 473.88 125" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 480.88 125 L 473.88 128.5 L 473.88 121.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(250.5,108.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="176" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">tokenreview.authentication.k8s.io</font></b></div></div></foreignObject><text x="88" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><path d="M 495 130 Q 550 130 550 149.5 Q 550 169 503.12 169" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 496.12 169 L 503.12 165.5 L 503.12 172.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(560.5,138.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="79" height="27" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">Verify Serivce<br />Account Token</font></b></div></div></foreignObject><text x="40" y="20" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><path d="M 486 190 L 350.5 190 Q 340.5 190 330.5 190 L 197.24 190" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 205.12 185.5 L 196.12 190 L 205.12 194.5" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(278.5,173.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="123" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">return User information</font></b></div></div></foreignObject><text x="62" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><path d="M 195 250 L 328.5 250 Q 338.5 250 348.5 250 L 473.88 250" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 480.88 250 L 473.88 253.5 L 473.88 246.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(230.5,233.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="216" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">subjectaccessreview.authorization.k8s.io</font></b></div></div></foreignObject><text x="108" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><path d="M 495 271 Q 550 271 550 290.5 Q 550 310 503.12 310" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 496.12 310 L 503.12 306.5 L 503.12 313.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(551.5,261.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="116" height="56" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">Verify User has<br />permission to access<br />target specified in<br />SubjectAccessReview</font></b><br /></div></div></foreignObject><text x="58" y="34" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><path d="M 485 324 L 350 324 Q 340 324 330 324 L 197.24 324" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 205.12 319.5 L 196.12 324 L 205.12 328.5" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(211.5,307.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="256" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">return wether User is allowed to access resource</font></b></div></div></foreignObject><text x="128" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><rect x="345" y="350" width="10" height="70" fill="#ffffff" stroke="#000000" pointer-events="none"/><path d="M 195 370 L 257.5 370 Q 267.5 370 277.5 370 L 331.88 370" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 338.88 370 L 331.88 373.5 L 331.88 366.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(209.5,353.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="116" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">Proxy original request</font></b></div></div></foreignObject><text x="58" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g><path d="M 345 410 L 210 410 Q 200 410 190 410 L 57.24 410" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 65.12 405.5 L 56.12 410 L 65.12 414.5" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(228.5,393.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="83" height="13" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><b><font face="Helvetica" style="font-size: 11px">Proxy response</font></b></div></div></foreignObject><text x="42" y="13" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">[Not supported by viewer]</text></switch></g></g></svg>

## Conclusion

If what you want to do is authorize certain requests with a static authorization profile, you may want to check out the [kube-rbac-proxy](https://github.com/brancz/kube-rbac-proxy).

While it may still be useful to perform authorization within your workload - especially when more fine grained or data specific access is required - it is good to know that in Kubernetes you have tools available that can get you a long way, before having to spend time on it.

Thanks for reading! If there are any question or feedback, feel free to let me know on Twitter [@fredbrancz](https://twitter.com/fredbrancz).

## Further reading

* More in depth documentation on the specifics of the SubjectAccessReview can be found in the [admin documentation](https://kubernetes.io/docs/admin/authorization/#review-your-request-attributes)
* [The code for the TokenReview type](https://github.com/kubernetes/kubernetes/blob/master/pkg/apis/authentication/types.go)
* [The code for the SubjectAccessReview type](https://github.com/kubernetes/kubernetes/blob/master/pkg/apis/authorization/types.go)
